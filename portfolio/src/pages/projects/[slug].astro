---
import { getCollection, getEntryBySlug } from 'astro:content';
import type { APIContext } from 'astro';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
  }));
}

export async function GET({ params }: APIContext) {
  if (!params.slug) {
    return new Response(null, { status: 404 });
  }
  const project = await getEntryBySlug('projects', params.slug);
  if (!project) {
    return new Response(null, { status: 404 });
  }
}

const { slug } = Astro.params;
const project = await getEntryBySlug('projects', slug!);

if (!project) {
  throw Astro.redirect('/', 302);
}

const { Content } = await project.render();
const { title, summary, cover, tags } = project.data;
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} · Justin Wu Projects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f172a;
        --surface: #ffffff;
        --text: #0f172a;
        --text-muted: #475569;
        --primary: #2563eb;
        --radius-lg: 26px;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      body {
        margin: 0;
        background: linear-gradient(160deg, #0f172a 0%, #1e293b 45%, #0f172a 100%);
        color: var(--text);
        min-height: 100vh;
      }
      .wrapper {
        max-width: 860px;
        margin: 0 auto clamp(3rem, 8vw, 5rem);
        padding: clamp(1.5rem, 4vw, 3rem);
      }
      a.back {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #fff;
        text-decoration: none;
        font-weight: 600;
        margin-bottom: clamp(1.5rem, 4vw, 2rem);
      }
      .cover {
        width: 100%;
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: 0 30px 60px rgba(15, 23, 42, 0.35);
        margin-bottom: clamp(2rem, 6vw, 3rem);
      }
      .cover img {
        width: 100%;
        display: block;
        height: auto;
      }
      .card {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: clamp(2rem, 4vw, 2.6rem);
        box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
      }
      h1 {
        margin: 0 0 1rem;
        font-size: clamp(2.2rem, 4vw, 2.8rem);
      }
      .summary {
        color: var(--text-muted);
        font-size: 1.05rem;
        line-height: 1.7;
        margin-bottom: 1.25rem;
      }
      .tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }
      .tag {
        padding: 0.4rem 0.85rem;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.12);
        color: var(--primary);
        font-size: 0.8rem;
        font-weight: 600;
        letter-spacing: 0.05em;
      }
      article {
        color: var(--text-muted);
        line-height: 1.8;
      }
      article :global(h2) {
        color: var(--text);
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        font-size: 1.6rem;
      }
      article :global(p) {
        margin-bottom: 1.2rem;
      }
      article :global(ul),
      article :global(ol) {
        margin: 1.2rem 0 1.6rem;
        padding-left: 1.5rem;
      }
      article :global(code) {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        background: rgba(15, 23, 42, 0.06);
        padding: 0.15rem 0.4rem;
        border-radius: 6px;
        font-size: 0.9rem;
      }
      article :global(pre) {
        background: rgba(15, 23, 42, 0.85);
        color: #f8fafc;
        padding: 1.5rem;
        border-radius: 14px;
        overflow-x: auto;
      }
      footer {
        margin-top: clamp(2.5rem, 6vw, 3.5rem);
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
        color: rgba(255, 255, 255, 0.75);
      }
      @media (max-width: 640px) {
        .card {
          padding: 1.75rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <a class="back" href="/">
        <span aria-hidden="true">←</span>
        Back to projects
      </a>

      {cover && (
        <div class="cover">
          <img src={cover} alt={`Cover image for ${title}`} loading="lazy" />
        </div>
      )}

      <div class="card">
        <h1>{title}</h1>
        <p class="summary">{summary}</p>
        {tags?.length ? (
          <div class="tags">
            {tags.map((tag) => (
              <span class="tag" key={tag}>{tag}</span>
            ))}
          </div>
        ) : null}
        <article>
          <Content />
        </article>
      </div>

      <footer>
        <span>Crafted by Justin Wu</span>
        <span>Need the build? Email justinwu@hey.com</span>
      </footer>
    </div>
  </body>
</html>
